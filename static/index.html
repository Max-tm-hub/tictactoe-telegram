<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <!-- –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ src -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 20px auto;
            max-width: 310px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cell.x {
            color: #ff5722;
        }
        .cell.o {
            color: #2196f3;
        }
        .cell.winner {
            background-color: #e8f5e9;
        }
        #status {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }
        #stats {
            font-size: 16px;
            margin: 10px 0;
            color: #555;
        }
        #inviteLink {
            margin: 10px 0;
            word-break: break-all;
        }
        #copyLinkBtn, #startGameBtn, #restartGameBtn, #closeGameBtn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        #restartGameBtn, #closeGameBtn {
            background-color: #2196f3; /* –°–∏–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ */
        }
        #closeGameBtn {
            background-color: #f44336; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
        }
        #chatBox {
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        #chatMessages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            margin-bottom: 10px;
            text-align: left;
        }
        #chatInput {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #sendBtn {
            width: 25%;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
    <div id="stats">üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö</div>
    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="board" class="board"></div> <!-- –ü–æ–ª–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã -->
    <div id="inviteLink"></div>
    <button id="copyLinkBtn" style="display: none;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <button id="startGameBtn" style="display: none;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button id="restartGameBtn" style="display: none;">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button id="closeGameBtn" style="display: none;">–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É</button>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" maxlength="100" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <script>
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ Telegram.WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        if (!window.Telegram || !window.Telegram.WebApp) {
            console.error("Telegram WebApp –æ–±—ä–µ–∫—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
            document.getElementById('status').textContent = "–û—à–∏–±–∫–∞: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
            throw new Error("Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
        }

        const Telegram = window.Telegram.WebApp;
        Telegram.expand();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–¥—Ä–µ—Å —Å–∞–π—Ç–∞
        const BACKEND = "https://tictactoe-telegram.onrender.com"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        let gameId = null;
        let gameWs = null;
        let chatWs = null;
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const statsDiv = document.getElementById('stats');
        const inviteLinkDiv = document.getElementById('inviteLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const restartGameBtn = document.getElementById('restartGameBtn');
        const closeGameBtn = document.getElementById('closeGameBtn'); // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É"
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ initDataUnsafe –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç user
        if (!Telegram.initDataUnsafe || !Telegram.initDataUnsafe.user) {
            console.error("Telegram WebApp initDataUnsafe.user –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ Telegram WebApp.");
            statusDiv.textContent = "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.";
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            throw new Error("Telegram WebApp initDataUnsafe.user –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
        }
        const initDataUnsafe = Telegram.initDataUnsafe;
        const urlParams = new URLSearchParams(window.location.search);
        const startParamFromURL = urlParams.get('startapp');
        const startParam = initDataUnsafe?.start_param || startParamFromURL;

        function connectGameWs(gameId) {
            // Correctly construct the WebSocket URL using the BACKEND variable
            const wsUrl = BACKEND.replace('https://', 'wss://').replace('http://', 'ws://');
            gameWs = new WebSocket(`${wsUrl}/ws/${gameId}`);
            gameWs.onopen = () => {
                console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∏–≥—Ä—ã", gameId);
            };
            gameWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç WebSocket –∏–≥—Ä—ã:", msg); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                if (msg.type === "game") {
                    renderGame(msg); // –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ–º renderGame –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                } else if (msg.type === "chat") {
                    chatMessages.innerHTML += `<div><b>${msg.username}:</b> ${msg.text}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            gameWs.onclose = (event) => {
                 if (event.code === 1000 && event.reason === "–ò–≥—Ä–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞") {
                     console.log("WebSocket –∏–≥—Ä—ã –∑–∞–∫—Ä—ã—Ç —Å–µ—Ä–≤–µ—Ä–æ–º: –∏–≥—Ä–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞.");
                     // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, renderGame –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É
                 } else {
                      statusDiv.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–π –ø–æ—Ç–µ—Ä—è–Ω–æ.";
                      console.log("WebSocket –∏–≥—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –∏–≥—Ä—ã", gameId, "–ö–æ–¥:", event.code, "–ü—Ä–∏—á–∏–Ω–∞:", event.reason);
                 }
            };
            gameWs.onerror = (error) => {
                 console.error("–û—à–∏–±–∫–∞ WebSocket –∏–≥—Ä—ã –¥–ª—è", gameId, error);
            };
        }

        function connectChatWs(gameId) {
             const wsUrl = BACKEND.replace('https://', 'wss://').replace('http://', 'ws://');
             // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
             if (chatWs) {
                 chatWs.close();
             }
             chatWs = new WebSocket(`${wsUrl}/ws/chat/${gameId}`);
             chatWs.onopen = () => {
                  console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞", gameId);
                  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏, –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏
                  sendBtn.style.backgroundColor = '#4caf50';
                  sendBtn.disabled = false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
             };
             chatWs.onmessage = (event) => {
                 const msg = JSON.parse(event.data);
                 console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç WebSocket —á–∞—Ç–∞:", msg); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                 if (msg.type === "chat") {
                      chatMessages.innerHTML += `<div><b>${msg.username}:</b> ${msg.text}</div>`;
                      chatMessages.scrollTop = chatMessages.scrollHeight;
                 }
             };
             chatWs.onclose = (event) => {
                  console.log("WebSocket —á–∞—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –∏–≥—Ä—ã", gameId, "–ö–æ–¥:", event.code, "–ü—Ä–∏—á–∏–Ω–∞:", event.reason);
                  // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                  // setTimeout(() => connectChatWs(gameId), 5000);
             };
             chatWs.onerror = (error) => {
                  console.error("–û—à–∏–±–∫–∞ WebSocket —á–∞—Ç–∞ –¥–ª—è", gameId, error);
                  // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                  sendBtn.style.backgroundColor = '#f44336';
                  sendBtn.disabled = true;
             };
        }

        async function loadStats() {
            try {
                const res = await fetch(`${BACKEND}/api/stats`, {
                    headers: { 'X-Init-Data': Telegram.initData }
                });
                const stats = await res.json();
                statsDiv.innerHTML = `üèÜ ${stats.wins || 0} –ø–æ–±–µ–¥ | üíÄ ${stats.losses || 0} –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù ${stats.draws || 0} –Ω–∏—á—å–∏—Ö`;
            } catch (e) {
                statsDiv.innerHTML = `üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö`;
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${e.message}`);
            }
        }

        async function createGame() {
            try {
                const res = await fetch(`${BACKEND}/api/create-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É");
                }
                const data = await res.json();
                gameId = data.game_id;
                inviteLinkDiv.innerHTML = `–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <a href="${data.invite_link}" target="_blank">${data.invite_link}</a>`;
                copyLinkBtn.style.display = 'block';
                connectGameWs(gameId);
                statusDiv.textContent = "–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
                boardDiv.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
                renderEmptyBoard(); // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Å—Ç–æ–π –¥–æ—Å–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            } catch (e) {
                statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É." });
                console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: ${e.message}`);
            }
        }

        async function joinGame(gameId) {
            try {
                const res = await fetch(`${BACKEND}/api/join-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ");
                }
                connectGameWs(gameId);
                connectChatWs(gameId); // –ü–æ–¥–∫–ª—é—á–∞–µ–º —á–∞—Ç –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                statusDiv.textContent = "–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!";
                boardDiv.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ—Å–∫—É –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
                // renderEmptyBoard(); // –£–±–∏—Ä–∞–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É, –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–ø–µ—Ä—å –≤ renderGame
            } catch (e) {
                statusDiv.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞." });
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ: ${e.message}`);
            }
        }

        async function startGame() {
            try {
                const res = await fetch(`${BACKEND}/api/start-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É");
                }
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ —á–µ—Ä–µ–∑ WebSocket.
                // renderGame() –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ onmessage.
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: statusDiv.textContent = "–ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É...";
            } catch (e) {
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É." });
                console.error(`–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã: ${e.message}`);
            }
        }

        async function restartGame() {
            try {
                const res = await fetch(`${BACKEND}/api/restart-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É");
                }
                const data = await res.json();
                // gameId –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–π ID
                gameId = data.new_game_id;
                // WebSocket –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç —Å–µ—Ä–≤–µ—Ä–æ–º, –∏ –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ renderGame
                console.log("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã —Å ID:", gameId);
                // renderGame –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            } catch (e) {
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É." });
                console.error(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã: ${e.message}`);
            }
        }

        async function makeMove(row, col) {
            console.log("–ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥ –≤ —è—á–µ–π–∫—É:", row, col, "Game ID:", gameId);
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ row –∏ col - —á–∏—Å–ª–∞ –≤ –Ω—É–∂–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
                if (typeof row !== 'number' || typeof col !== 'number' || row < 0 || row > 2 || col < 0 || col > 2) {
                    throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ö–æ–¥–∞: row=${row}, col=${col}`);
                }
                const res = await fetch(`${BACKEND}/api/make-move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId, row, col })
                });
                if (!res.ok) {
                    const errorText = await res.text(); // –ü–æ–ª—É—á–∏–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    console.error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${res.status} ${res.statusText}`, errorText);
                    throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${res.status} ${res.statusText}`);
                }
                console.log("–•–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
            } catch (e) {
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥." });
                console.error(`–û—à–∏–±–∫–∞ —Ö–æ–¥–∞: ${e.message}`);
            }
        }

        function renderEmptyBoard() {
            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    boardDiv.appendChild(cell);
                }
            }
        }

        function renderGame(game) {
            console.log("–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã —Å –¥–∞–Ω–Ω—ã–º–∏:", game); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º initDataUnsafe —Å–Ω–æ–≤–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ
            if (!Telegram.initDataUnsafe || !Telegram.initDataUnsafe.user) {
                console.error("Telegram WebApp initDataUnsafe.user –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ.");
                statusDiv.textContent = "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.";
                return;
            }
            const user = Telegram.initDataUnsafe.user; // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é
            const myId = String(user.id);
            const isCreator = myId === String(game.creator_id);
            const mySymbol = isCreator ? 'X' : 'O';
            const opponentName = game.opponent_name || '–û–∂–∏–¥–∞–Ω–∏–µ...';
            const creatorName = game.creator_name;

            console.log("–ú–æ–π ID:", myId, "ID –°–æ–∑–¥–∞—Ç–µ–ª—è:", game.creator_id, "–Ø —Å–æ–∑–¥–∞—Ç–µ–ª—å:", isCreator); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ –∏–≥—Ä–∞ (winner –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏ –Ω–µ null/undefined)
            const isGameFinished = game.winner !== null && game.winner !== undefined;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
            if (game.winner === 'draw') {
                statusDiv.textContent = "–ù–∏—á—å—è!";
            } else if (game.winner) { // –°—é–¥–∞ –ø–æ–ø–∞–¥–∞–µ–º, –µ—Å–ª–∏ winner === 'X' –∏–ª–∏ 'O'
                const winnerName = game.winner === 'X' ? creatorName : opponentName;
                statusDiv.textContent = `–ü–æ–±–µ–¥–∏–ª(–∞) ${winnerName}!`;
            } else if (!game.opponent_id) {
                statusDiv.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
                document.getElementById('startGameBtn').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç
                boardDiv.style.display = 'none'; // –°–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É
            } else if (!game.game_started) {
                statusDiv.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...";
                boardDiv.style.display = 'none'; // –°–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É –¥–æ –Ω–∞—á–∞–ª–∞
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É" —Ç–æ–ª—å–∫–æ –≤—Ç–æ—Ä–æ–º—É –∏–≥—Ä–æ–∫—É, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å –∏ –≤—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
                if (!isCreator) {
                    console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É' –≤—Ç–æ—Ä–æ–º—É –∏–≥—Ä–æ–∫—É.");
                    document.getElementById('startGameBtn').style.display = 'block';
                } else {
                    console.log("–°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É' –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è.");
                    document.getElementById('startGameBtn').style.display = 'none';
                }
            } else { // –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å (game.game_started === true)
                statusDiv.textContent = "–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!"; // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                document.getElementById('startGameBtn').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞
                boardDiv.style.display = 'grid'; // –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å–∫—É
                // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ game.board - —ç—Ç–æ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤
                let boardToRender = game.board;
                if (typeof game.board === 'string') {
                    try {
                        boardToRender = JSON.parse(game.board);
                        console.log("–î–æ—Å–∫–∞ –±—ã–ª–∞ —Å—Ç—Ä–æ–∫–æ–π, —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–∞ –≤:", boardToRender);
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ—Å–∫–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏:", e, "–ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:", game.board);
                        statusDiv.textContent = "–û—à–∏–±–∫–∞: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏.";
                        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É
                    }
                }
                if (!Array.isArray(boardToRender) || boardToRender.length !== 3 || !boardToRender.every(row => Array.isArray(row) && row.length === 3)) {
                     console.error("–î–æ—Å–∫–∞ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:", boardToRender);
                     statusDiv.textContent = "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ—Å–∫–∏.";
                     return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É
                }
                // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
                // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É
                boardDiv.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        const val = boardToRender[i][j]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º boardToRender
                        if (val) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ val - —ç—Ç–æ 'X' –∏–ª–∏ 'O'
                            if (val === 'X' || val === 'O') {
                                cell.textContent = val;
                                cell.classList.add(val.toLowerCase());
                                // –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º isGameFinished, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                                if (isGameFinished && game.winner && val === game.winner) {
                                    cell.classList.add('winner');
                                }
                            } else {
                                console.warn(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ [${i}][${j}]: ${val}`);
                                // –û—Å—Ç–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å—Ç–∞–≤–∏–º –ø—Ä–æ–±–µ–ª, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ 'X' –∏ –Ω–µ 'O'
                                cell.textContent = '';
                            }
                        }
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
                        if (game.game_started && !isGameFinished && game.current_turn == myId && !val) {
                            cell.onclick = () => makeMove(i, j);
                        }
                        boardDiv.appendChild(cell);
                    }
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ö–æ–¥–∞, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω–∞
                if (!isGameFinished) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º isGameFinished
                    if (game.current_turn == myId) {
                        statusDiv.textContent = "–í–∞—à —Ö–æ–¥!";
                    } else {
                        statusDiv.textContent = "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
                    }
                } else { // –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    console.log("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, winner:", game.winner, "isCreator:", isCreator);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤–∞—è –∏–≥—Ä–∞" –∏ "–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É" –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    if (isCreator) { // –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                         console.log("–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫–∏ '–ù–æ–≤–∞—è –∏–≥—Ä–∞' –∏ '–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É' —Å–æ–∑–¥–∞—Ç–µ–ª—é.");
                         restartGameBtn.style.display = 'inline-block';
                         closeGameBtn.style.display = 'inline-block';
                    } else {
                         // –í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é
                         console.log("–°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ '–ù–æ–≤–∞—è –∏–≥—Ä–∞' –∏ '–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É' –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞.");
                         restartGameBtn.style.display = 'none';
                         closeGameBtn.style.display = 'none';
                    }
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç, –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
            if (game.opponent_id) {
                document.getElementById('chatBox').style.display = 'block';
                // –ï—Å–ª–∏ —á–∞—Ç–æ–≤—ã–π WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
                if (!chatWs || chatWs.readyState === WebSocket.CLOSED) {
                     connectChatWs(gameId);
                }
            } else {
                // –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
                document.getElementById('chatBox').style.display = 'none';
            }
        }

        copyLinkBtn.onclick = () => {
            const linkEl = inviteLinkDiv.querySelector('a');
            if (!linkEl) return;
            const url = linkEl.href;
            navigator.clipboard.writeText(url).then(() => {
                Telegram.showPopup({ title: "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!", message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!" });
            }).catch(() => {
                Telegram.showPopup({ title: "‚ùå –û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É." });
            });
        };

        startGameBtn.onclick = startGame;
        restartGameBtn.onclick = restartGame;
        closeGameBtn.onclick = () => {
            // –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            Telegram.WebApp.close();
        };

        sendBtn.onclick = () => {
            const text = chatInput.value.trim();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç–æ–≤—ã–π WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –æ—Ç–∫—Ä—ã—Ç
            if (text && chatWs && chatWs.readyState === WebSocket.OPEN) {
                try {
                    chatWs.send(JSON.stringify({ initData: Telegram.initData, text }));
                    chatInput.value = '';
                } catch (e) {
                    Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ." });
                    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ WebSocket —á–∞—Ç–∞: ${e.message}`);
                }
            } else {
                 // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                 Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —á–∞—Ç–æ–º –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ." });
                 console.error("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç, –Ω–æ WebSocket –Ω–µ –æ—Ç–∫—Ä—ã—Ç. ReadyState:", chatWs ? chatWs.readyState : 'undefined');
                 // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                 if (gameId) {
                      connectChatWs(gameId);
                 }
            }
        };

        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendBtn.click(); };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded —Å initDataUnsafe:", Telegram.initDataUnsafe); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            await loadStats();
            if (startParam && typeof startParam === 'string' && startParam.length === 8) {
                gameId = startParam;
                await joinGame(gameId);
            } else {
                await createGame();
            }
        });
    </script>
</body>
</html>
