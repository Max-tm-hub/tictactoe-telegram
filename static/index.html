<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui, -apple-system, sans-serif; }
        body { padding:16px; background:#f9f9f9; max-width:500px; margin:0 auto; }
        h1 { text-align:center; margin:16px 0; color:#333; }
        #stats { text-align:center; margin:10px 0; font-size:0.9rem; color:#555; }
        .status { text-align:center; padding:12px; background:#fff; border-radius:10px; margin:16px 0; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
        .board { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:320px; margin:0 auto; }
        .cell {
            aspect-ratio:1; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center;
            font-size:2.2rem; font-weight:bold; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
        }
        .cell:hover { transform: scale(1.03); }
        .cell.x { color:#e74c3c; }
        .cell.o { color:#3498db; }
        .cell.winner { animation: pulse 1.5s infinite; background:#e6f7ee !important; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .cell.x, .cell.o { animation: popIn 0.3s ease-out; }
        @keyframes popIn {
            0% { transform: scale(0); opacity:0; }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); opacity:1; }
        }
        .btn {
            width:100%; padding:14px; margin:10px 0; border:none; border-radius:12px;
            background:linear-gradient(135deg, #667eea, #764ba2); color:white; font-size:1.1rem; font-weight:600;
            cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
        #inviteLink { text-align:center; margin:10px 0; font-size:0.9rem; color:#555; word-break: break-all; }
        #copyLinkBtn { width:100%; padding:10px; margin:10px 0; border:none; border-radius:12px; background:#28a745; color:white; font-size:1rem; font-weight:600; cursor:pointer; }
        #chatBox {
            margin-top:20px; display:none; background:#fff; padding:16px; border-radius:12px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1);
        }
        #chatMessages {
            height:140px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:8px;
            background:#fafafa; margin-bottom:10px; font-size:0.95rem;
        }
        #chatInput {
            width:70%; padding:10px; border:1px solid #ddd; border-radius:8px;
        }
        #sendBtn {
            width:28%; padding:10px; background:#28a745; color:white; border:none; border-radius:8px;
            margin-left:2%;
        }
    </style>
</head>
<body>
    <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
    <div id="stats">üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö</div>
    <div id="status" class="status">–°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã...</div>
    <div id="board" class="board"></div>
    <div id="inviteLink"></div>
    <button id="copyLinkBtn" style="display: none;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <div id="chatBox">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" maxlength="100" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <script>
        const Telegram = window.Telegram.WebApp;
        Telegram.expand();
        const BACKEND = "https://tictactoe-telegram.onrender.com"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥
        let gameId = null;
        let gameWs = null;
        let chatWs = null;
        const urlParams = new URLSearchParams(window.location.search);
        const startParam = urlParams.get('start');
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const statsDiv = document.getElementById('stats');
        const inviteLinkDiv = document.getElementById('inviteLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket –∏–≥—Ä—ã
        function connectGameWs(gameId) {
            gameWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/${gameId}`);
            gameWs.onopen = () => {
                console.log("Game WebSocket connected");
            };
            gameWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "game") {
                    renderGame(msg);
                } else if (msg.type === "chat") {
                    chatMessages.innerHTML += `<div><b>${msg.username}:</b> ${msg.text}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            gameWs.onerror = (error) => {
                console.error("Game WebSocket error:", error);
                statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
            };
            gameWs.onclose = () => {
                statusDiv.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket —á–∞—Ç–∞
        function connectChatWs(gameId) {
            chatWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/chat/${gameId}`);
            chatWs.onopen = () => {
                console.log("Chat WebSocket connected");
            };
            chatWs.onerror = (error) => {
                console.error("Chat WebSocket error:", error);
            };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const res = await fetch(`${BACKEND}/api/stats`, {
                    headers: {'X-Init-Data': Telegram.initData}
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const stats = await res.json();
                statsDiv.innerHTML = `üèÜ ${stats.wins || 0} –ø–æ–±–µ–¥ | üíÄ ${stats.losses || 0} –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù ${stats.draws || 0} –Ω–∏—á—å–∏—Ö`;
            } catch (e) {
                console.error("Stats error:", e);
                statsDiv.innerHTML = `üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö`;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
        async function createGame() {
            try {
                const res = await fetch(`${BACKEND}/api/create-game`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: Telegram.initData})
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                if (data.game_id) {
                    gameId = data.game_id;
                    inviteLinkDiv.innerHTML = `–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <a href="${data.invite_link}">${data.invite_link}</a>`;
                    copyLinkBtn.style.display = 'block';
                    connectGameWs(gameId);
                    statusDiv.textContent = "–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
                    renderEmptyBoard();
                }
            } catch (error) {
                console.error("Create game error:", error);
                statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
                Telegram.WebApp.showPopup({title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É!"});
            }
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ
        async function joinGame(gameId) {
            try {
                const res = await fetch(`${BACKEND}/api/join-game`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: Telegram.initData, game_id: gameId})
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                if (data.status === "ok") {
                    connectGameWs(gameId);
                    connectChatWs(gameId);
                    statusDiv.textContent = "–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!";
                }
            } catch (error) {
                console.error("Join game error:", error);
                statusDiv.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ.";
                Telegram.WebApp.showPopup({title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ!"});
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Å—Ç–æ–≥–æ –ø–æ–ª—è
        function renderEmptyBoard() {
            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    boardDiv.appendChild(cell);
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
        function renderGame(game) {
            const user = JSON.parse(decodeURIComponent(Telegram.initDataUnsafe.user));
            const myId = user.id;
            const isCreator = myId == game.creator_id;
            const mySymbol = isCreator ? 'X' : 'O';
            const opponentName = game.opponent_name || '–û–∂–∏–¥–∞–Ω–∏–µ...';
            const creatorName = game.creator_name;

            if (game.winner === 'draw') {
                statusDiv.textContent = "–ù–∏—á—å—è!";
            } else if (game.winner) {
                const winnerName = game.winner === 'X' ? creatorName : opponentName;
                statusDiv.textContent = `–ü–æ–±–µ–¥–∏–ª ${winnerName}!`;
            } else if (!game.opponent_id) {
                statusDiv.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
            } else if (game.current_turn == myId) {
                statusDiv.textContent = "–í–∞—à —Ö–æ–¥!";
            } else {
                statusDiv.textContent = "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
            }

            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const val = game.board[i][j];
                    if (val) {
                        cell.textContent = val;
                        cell.classList.add(val.toLowerCase());
                        if (game.winner && (
                            (game.winner === 'X' && val === 'X') ||
                            (game.winner === 'O' && val === 'O')
                        )) {
                            cell.classList.add('winner');
                        }
                    }
                    if (!game.winner && game.current_turn == myId && !val) {
                        cell.onclick = () => makeMove(i, j);
                    }
                    boardDiv.appendChild(cell);
                }
            }
            if (game.opponent_id) {
                document.getElementById('chatBox').style.display = 'block';
            }
        }

        // –•–æ–¥ –∏–≥—Ä–æ–∫–∞
        async function makeMove(row, col) {
            try {
                const res = await fetch(`${BACKEND}/api/make-move`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: Telegram.initData, game_id: gameId, row, col})
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                if (data.status !== "ok") {
                    Telegram.WebApp.showPopup({title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥!"});
                }
            } catch (error) {
                console.error("Make move error:", error);
                Telegram.WebApp.showPopup({title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥!"});
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        copyLinkBtn.onclick = () => {
            const link = inviteLinkDiv.querySelector('a').href;
            navigator.clipboard.writeText(link)
                .then(() => {
                    Telegram.WebApp.showPopup({title: "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!", message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"});
                })
                .catch((err) => {
                    console.error("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ", err);
                    Telegram.WebApp.showPopup({title: "‚ùå –û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É!"});
                });
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        sendBtn.onclick = sendMessage;
        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text && chatWs && chatWs.readyState === WebSocket.OPEN) {
                chatWs.send(JSON.stringify({initData: Telegram.initData, text: text}));
                chatInput.value = '';
            }
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            if (startParam && startParam.length === 8) {
                statusDiv.textContent = "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...";
                await joinGame(startParam);
            } else {
                await createGame();
            }
        });
    </script>
</body>
</html>
