<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏ */
    </style>
</head>
<body>
    <!-- HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π -->
    <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
    <div id="stats">üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö</div>
    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="board" class="board"></div>
    <div id="inviteLink"></div>
    <button id="copyLinkBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <div id="chatBox">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" maxlength="100" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <script>
        const Telegram = window.Telegram.WebApp;
        Telegram.expand();
        const BACKEND = "https://your_backend_server"; // –ó–¥–µ—Å—å –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å —Å–≤–æ–µ–≥–æ –±–µ–∫—ç–Ω–¥–∞
        let gameId = null;
        let gameWs = null;
        let chatWs = null;
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const statsDiv = document.getElementById('stats');
        const inviteLinkDiv = document.getElementById('inviteLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const initDataUnsafe = Telegram.initDataUnsafe;

        // –ü–æ–ª—É—á–∞–µ–º startParam –∏–∑ URL –∏–ª–∏ initData
        const urlParams = new URLSearchParams(window.location.search);
        const startParamFromURL = urlParams.get('startapp');
        const startParam = initDataUnsafe?.start_param || startParamFromURL;

        function connectGameWs(gameId) {
            gameWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/${gameId}`);
            gameWs.onopen = () => {
                console.log("WebSocket connection established");
            };
            gameWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "game") {
                    renderGame(msg);
                } else if (msg.type === "chat") {
                    chatMessages.innerHTML += `<div><b>${msg.username}:</b> ${msg.text}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            gameWs.onclose = gameWs.onerror = () => {
                statusDiv.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–π –ø–æ—Ç–µ—Ä—è–Ω–æ.";
            };
        }

        function connectChatWs(gameId) {
            chatWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/chat/${gameId}`);
        }

        async function loadStats() {
            try {
                const res = await fetch(`${BACKEND}/api/stats`, {
                    headers: { 'X-Init-Data': Telegram.initData }
                });
                const stats = await res.json();
                statsDiv.innerHTML = `üèÜ ${stats.wins || 0} –ø–æ–±–µ–¥ | üíÄ ${stats.losses || 0} –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù ${stats.draws || 0} –Ω–∏—á—å–∏—Ö`;
            } catch (e) {
                statsDiv.innerHTML = `üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö`;
            }
        }

        async function createGame() {
            try {
                const res = await fetch(`${BACKEND}/api/create-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData })
                });
                const data = await res.json();
                gameId = data.game_id;
                inviteLinkDiv.innerHTML = `–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <a href="${data.invite_link}" target="_blank">${data.invite_link}</a>`;
                copyLinkBtn.style.display = 'block';
                connectGameWs(gameId);
                statusDiv.textContent = "–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";                 renderEmptyBoard();
            } catch (e) {
                statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É." });
            }
        }

        async function joinGame(gameId) {
            try {
                const res = await fetch(`${BACKEND}/api/join-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId })
                });
                if (res.ok) {
                    connectGameWs(gameId);
                    connectChatWs(gameId);
                    statusDiv.textContent = "–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!";
                    renderEmptyBoard(); // –ß—Ç–æ–±—ã –ø—Ä–æ—Ä–∏—Å–æ–≤–∞—Ç—å –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –ø–æ—Å–ª–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                } else {
                    throw new Error("Join failed");
                }
            } catch (e) {
                statusDiv.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞." });
            }
        }

        async function makeMove(row, col) {
            try {
                await fetch(`${BACKEND}/api/make-move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId, row, col })
                });
            } catch (e) {
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥." });
            }
        }

        function renderEmptyBoard() {
            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    boardDiv.appendChild(cell);
                }
            }
        }

        function renderGame(game) {
            const user = JSON.parse(decodeURIComponent(Telegram.initDataUnsafe.user));
            const myId = String(user.id);
            const isCreator = myId === String(game.creator_id);
            const mySymbol = isCreator ? 'X' : 'O';
            const opponentName = game.opponent_name || '–û–∂–∏–¥–∞–Ω–∏–µ...';
            const creatorName = game.creator_name;

            if (game.winner === 'draw') {
                statusDiv.textContent = "–ù–∏—á—å—è!";
            } else if (game.winner) {
                const winnerName = game.winner === 'X' ? creatorName : opponentName;
                statusDiv.textContent = `–ü–æ–±–µ–¥–∏–ª(–∞) ${winnerName}!`;
            } else if (!game.opponent_id) {
                statusDiv.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
            } else if (game.current_turn == myId) {
                statusDiv.textContent = "–í–∞—à —Ö–æ–¥!";
            } else {
                statusDiv.textContent = "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
            }

            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const val = game.board[i][j];
                    if (val) {
                        cell.textContent = val;
                        cell.classList.add(val.toLowerCase());
                        if (game.winner && val === game.winner) {
                            cell.classList.add('winner');
                        }
                    }
                    if (!game.winner && game.current_turn == myId && !val) {
                        cell.onclick = () => makeMove(i, j);
                    }
                    boardDiv.appendChild(cell);
                }
            }
            if (game.opponent_id) {
                document.getElementById('chatBox').style.display = 'block';
            }
        }

        copyLinkBtn.onclick = () => {
            const linkEl = inviteLinkDiv.querySelector('a');
            if (!linkEl) return;
            const url = linkEl.href;
            navigator.clipboard.writeText(url).then(() => {
                Telegram.showPopup({ title: "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!", message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!" });
            }).catch(() => {
                Telegram.showPopup({ title: "‚ùå –û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É." });
            });
        };

        sendBtn.onclick = () => {
            const text = chatInput.value.trim();
            if (text && chatWs?.readyState === WebSocket.OPEN) {
                chatWs.send(JSON.stringify({ initData: Telegram.initData, text }));
                chatInput.value = '';
            }
        };

        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendBtn.click(); };

        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            if (startParam && typeof startParam === 'string' && startParam.length === 8) {
                gameId = startParam;
                await joinGame(gameId);
            } else {
                await createGame();
            }
        });
    </script>
</body>
</html>
