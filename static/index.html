<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 20px auto;
            max-width: 310px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cell.x {
            color: #ff5722;
        }
        .cell.o {
            color: #2196f3;
        }
        .cell.winner {
            background-color: #e8f5e9;
        }
        #status {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }
        #stats {
            font-size: 16px;
            margin: 10px 0;
            color: #555;
        }
        #inviteLink {
            margin: 10px 0;
            word-break: break-all;
        }
        #copyLinkBtn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        #chatBox {
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        #chatMessages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            margin-bottom: 10px;
            text-align: left;
        }
        #chatInput {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #sendBtn {
            width: 25%;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
    <div id="stats">üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö</div>
    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="board" class="board"></div>
    <div id="inviteLink"></div>
    <button id="copyLinkBtn" style="display: none;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" maxlength="100" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <script>
        const Telegram = window.Telegram.WebApp;
        Telegram.expand();
        const BACKEND = "https://your_backend_server"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        let gameId = null;
        let gameWs = null;
        let chatWs = null;
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const statsDiv = document.getElementById('stats');
        const inviteLinkDiv = document.getElementById('inviteLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const initDataUnsafe = Telegram.initDataUnsafe;

        const urlParams = new URLSearchParams(window.location.search);
        const startParamFromURL = urlParams.get('startapp');
        const startParam = initDataUnsafe?.start_param || startParamFromURL;

        function connectGameWs(gameId) {
            gameWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/${gameId}`);
            gameWs.onopen = () => {
                console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            };
            gameWs.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "game") {
                    renderGame(msg);
                } else if (msg.type === "chat") {
                    chatMessages.innerHTML += `<div><b>${msg.username}:</b> ${msg.text}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            gameWs.onclose = gameWs.onerror = () => {
                statusDiv.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–π –ø–æ—Ç–µ—Ä—è–Ω–æ.";
            };
        }

        function connectChatWs(gameId) {
            chatWs = new WebSocket(`wss://${BACKEND.replace('https://', '')}/ws/chat/${gameId}`);
        }

        async function loadStats() {
            try {
                const res = await fetch(`${BACKEND}/api/stats`, {
                    headers: { 'X-Init-Data': Telegram.initData }
                });
                const stats = await res.json();
                statsDiv.innerHTML = `üèÜ ${stats.wins || 0} –ø–æ–±–µ–¥ | üíÄ ${stats.losses || 0} –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù ${stats.draws || 0} –Ω–∏—á—å–∏—Ö`;
            } catch (e) {
                statsDiv.innerHTML = `üèÜ 0 –ø–æ–±–µ–¥ | üíÄ 0 –ø–æ—Ä–∞–∂–µ–Ω–∏–π | ü§ù 0 –Ω–∏—á—å–∏—Ö`;
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${e.message}`);
            }
        }

        async function createGame() {
            try {
                const res = await fetch(`${BACKEND}/api/create-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É");
                }
                const data = await res.json();
                gameId = data.game_id;
                inviteLinkDiv.innerHTML = `–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <a href="${data.invite_link}" target="_blank">${data.invite_link}</a>`;
                copyLinkBtn.style.display = 'block';
                connectGameWs(gameId);
                statusDiv.textContent = "–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
                renderEmptyBoard();
            } catch (e) {
                statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É." });
                console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: ${e.message}`);
            }
        }

        async function joinGame(gameId) {
            try {
                const res = await fetch(`${BACKEND}/api/join-game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ");
                }
                connectGameWs(gameId);
                connectChatWs(gameId);
                statusDiv.textContent = "–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!";
                renderEmptyBoard();
            } catch (e) {
                statusDiv.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è.";
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞." });
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ: ${e.message}`);
            }
        }

        async function makeMove(row, col) {
            try {
                const res = await fetch(`${BACKEND}/api/make-move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: Telegram.initData, game_id: gameId, row, col })
                });
                if (!res.ok) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥");
                }
            } catch (e) {
                Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥." });
                console.error(`–û—à–∏–±–∫–∞ —Ö–æ–¥–∞: ${e.message}`);
            }
        }

        function renderEmptyBoard() {
            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    boardDiv.appendChild(cell);
                }
            }
        }

        function renderGame(game) {
            const user = JSON.parse(decodeURIComponent(Telegram.initDataUnsafe.user));
            const myId = String(user.id);
            const isCreator = myId === String(game.creator_id);
            const mySymbol = isCreator ? 'X' : 'O';
            const opponentName = game.opponent_name || '–û–∂–∏–¥–∞–Ω–∏–µ...';
            const creatorName = game.creator_name;

            if (game.winner === 'draw') {
                statusDiv.textContent = "–ù–∏—á—å—è!";
            } else if (game.winner) {
                const winnerName = game.winner === 'X' ? creatorName : opponentName;
                statusDiv.textContent = `–ü–æ–±–µ–¥–∏–ª(–∞) ${winnerName}!`;
            } else if (!game.opponent_id) {
                statusDiv.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...";
            } else if (game.current_turn == myId) {
                statusDiv.textContent = "–í–∞—à —Ö–æ–¥!";
            } else {
                statusDiv.textContent = "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
            }

            boardDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const val = game.board[i][j];
                    if (val) {
                        cell.textContent = val;
                        cell.classList.add(val.toLowerCase());
                        if (game.winner && val === game.winner) {
                            cell.classList.add('winner');
                        }
                    }
                    if (!game.winner && game.current_turn == myId && !val) {
                        cell.onclick = () => makeMove(i, j);
                    }
                    boardDiv.appendChild(cell);
                }
            }
            if (game.opponent_id) {
                document.getElementById('chatBox').style.display = 'block';
            }
        }

        copyLinkBtn.onclick = () => {
            const linkEl = inviteLinkDiv.querySelector('a');
            if (!linkEl) return;
            const url = linkEl.href;
            navigator.clipboard.writeText(url).then(() => {
                Telegram.showPopup({ title: "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!", message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!" });
            }).catch(() => {
                Telegram.showPopup({ title: "‚ùå –û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É." });
            });
        };

        sendBtn.onclick = () => {
            const text = chatInput.value.trim();
            if (text && chatWs?.readyState === WebSocket.OPEN) {
                try {
                    chatWs.send(JSON.stringify({ initData: Telegram.initData, text }));
                    chatInput.value = '';
                } catch (e) {
                    Telegram.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ." });
                    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${e.message}`);
                }
            }
        };

        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendBtn.click(); };

        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            if (startParam && typeof startParam === 'string' && startParam.length === 8) {
                gameId = startParam;
                await joinGame(gameId);
            } else {
                await createGame();
            }
        });
    </script>
</body>
</html>
